#include <stdio.h>
#include <stdbool.h>
#include "sem.h"

int B_num;      //Buffer size 
int P_num;      //# of producers
int C_num;      //# of consumers 
int N_num;      //# times they run their loops

struct semaphore *full; 
struct semaphore *empty; 

int in = 0; int out = 0; 

int* Buffer; 

void producer(); 
void consumer(); 

int main()
{   
    scanf("%d,%d,%d,%d",&B_num,&P_num,&C_num,&N_num);

    full = (struct semaphore *)malloc(sizeof(struct semaphore)); 
    empty = (struct semaphore *)malloc(sizeof(struct semaphore)); 
    runQ = (struct queue*)malloc(sizeof(struct queue)); 

    initQueue(runQ); 
    initSem(full, 0); 
    initSem(empty, B_num); 

    Buffer = (int*)malloc(B_num * sizeof(int));

    for(int k = 0; k < P_num + C_num; k++)
    {
        int id; 
        scanf("%d", &id);

        if(id > 0)              //ID > 0, create producer 
        {
            startThread(producer, id);
        }else                   //ID < 0, create consumer 
        {   
            id = -id;                       
            startThread(consumer, id); 
        }
    }

    run(); 
    return 0; 
}

void producer(int id)
{
    TCB_t *tcb; 
    int i = 0; 
    while(i < N_num) 
    {
        P(empty, id);
        int itemNumber = i + 1;
        printf("\n Producer %d is producing item number %d\n", id, itemNumber); 

        Buffer[in] = id; 
        in = (in + 1) % B_num;
        i++; 
        V(full);
        yield(); 
    }
    tcb = delQueue(runQ); 
    if(runQ == NULL) 
        exit(0); 
    swapcontext(&(tcb->context), &(runQ->header->context)); 

}

void consumer(int id)
{
    TCB_t *tcb; 
    int i = 0;
    while(i < N_num)
    {
        P(full, id); 
        printf("\n Consumer %d is consuming item generated by Producer %d\n", id, Buffer[out]); 

        Buffer[out] = 0; 
        out = (out + 1) % B_num; 
        i++; 
        V(empty); 
        yield();
    }
    tcb = delQueue(runQ); 
    if(runQ == NULL) 
        exit(0); 
    swapcontext(&(tcb->context), &(runQ->header->context)); 
}



